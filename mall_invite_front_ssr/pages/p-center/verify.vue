<template>
  <div class="guge-verify">
    <div class="module-title">谷歌验证</div>
    <div class="guge-verify-body">
      <div class="subtit">
        <span class="nub">1</span>
        <span class="text">在手机上安装谷歌验证器(Google Authenticator)</span>
      </div>
      <div class="doneload">
        <div class="log">
          <img src="../../assets/image/google-auth.png" alt="谷歌验证">
          <div class="text">Authenticator</div>
        </div>
        <div class="btn">
          <div class="doneload-btn">
            <a href="https://itunes.apple.com/cn/app/id388497605?mt=8" target="_blank">
              <div class="store-icon left">
                <i class="icon-apple">
                  <svg width="15px" height="19px" viewBox="0 0 15 19" version="1.1"
                       xmlns="http://www.w3.org/2000/svg"
                       xmlns:xlink="http://www.w3.org/1999/xlink">
                    <!-- Generator: Sketch 49 (51002) - http://www.bohemiancoding.com/sketch -->
                    <title>App Store</title>
                    <desc>Created with Sketch.</desc>
                    <defs></defs>
                    <g id="算立方1.0第一部分" stroke="none" stroke-width="1" fill="none"
                       fill-rule="evenodd">
                      <g id="11.9安全中心_Google验证" transform="translate(-664.000000, -404.000000)"
                         fill="#4D2EEA">
                        <g id="Group" transform="translate(639.000000, 396.000000)">
                          <path d="M35.2072775,10.9409601 C35.8499421,10.1621283 36.2829287,9.07837167 36.1658052,8 C35.239924,8.03811561 34.1180518,8.61540303 33.4535949,9.3942348 C32.8600123,10.0858691 32.3344431,11.1886975 32.4761356,12.2452488 C33.5081459,12.3269772 34.564613,11.7197077 35.2072775,10.9409601 M37.5273935,17.7867088 C37.5028526,15.4531023 39.4308462,14.3338664 39.5152109,14.2794276 C38.4342029,12.6973072 36.7485337,12.4793835 36.1467334,12.4522062 C34.7117466,12.3079334 33.3474097,13.296359 32.6204084,13.296359 C31.8933791,13.296359 30.7713666,12.4740266 29.5815088,12.4957068 C28.0184323,12.5202477 26.5779763,13.4052647 25.771855,14.8048565 C24.1462341,17.6259725 25.3551917,21.8032078 26.9400326,24.0879007 C27.7134232,25.2070524 28.6365558,26.4623714 29.8483742,26.4188708 C31.013719,26.3725375 31.4548953,25.6645519 32.8654814,25.6645519 C34.2760394,25.6645519 34.6708824,26.4188708 35.9071295,26.3970784 C37.1624485,26.3725375 37.9576315,25.2560221 38.725497,24.1341499 C39.6132626,22.8352181 39.9809282,21.5771786 40,21.5172426 C39.9727105,21.5009193 37.5519345,20.5751503 37.5273935,17.7867088"
                                id="App-Store"></path>
                        </g>
                      </g>
                    </g>
                  </svg>
                </i>
                <span class="text">iOS下载</span>
              </div>
            </a>
          </div>

          <div class="doneload-btn">
            <a href="http://android.myapp.com/myapp/detail.htm?apkName=com.google.android.apps.authenticator2"
               target="_blank">
              <div class="store-icon left">
                <i class="icon-google">
                  <svg width="16px" height="20px" viewBox="0 0 16 20" version="1.1"
                       xmlns="http://www.w3.org/2000/svg"
                       xmlns:xlink="http://www.w3.org/1999/xlink">
                    <!-- Generator: Sketch 49 (51002) - http://www.bohemiancoding.com/sketch -->
                    <title>Android</title>
                    <desc>Created with Sketch.</desc>
                    <defs></defs>
                    <g id="算立方1.0第一部分" stroke="none" stroke-width="1" fill="none"
                       fill-rule="evenodd">
                      <g id="11.13安全中心_Google验证" transform="translate(-657.000000, -459.000000)"
                         fill="#4D2EEA">
                        <g id="Page-1" transform="translate(657.000000, 459.000000)">
                          <g id="Group-7">
                            <path
                              d="M10.0000169,4.16744297 C9.7790896,4.16744297 9.60000541,3.98096023 9.60000541,3.75090569 L9.60000541,3.75068037 C9.60000541,3.52062583 9.7790896,3.33414309 10.0000169,3.33414309 C10.2209442,3.33414309 10.4000284,3.52062583 10.4000284,3.75068037 L10.4000284,3.75090569 C10.4000284,3.98096023 10.2209442,4.16744297 10.0000169,4.16744297 Z M5.9999831,4.16744297 C5.77905579,4.16744297 5.5999716,3.98096023 5.5999716,3.75090569 L5.5999716,3.75068037 C5.5999716,3.52062583 5.77905579,3.33414309 5.9999831,3.33414309 C6.2209104,3.33414309 6.39999459,3.52062583 6.39999459,3.75068037 L6.39999459,3.75090569 C6.39999459,3.98096023 6.2209104,4.16744297 5.9999831,4.16744297 Z M10.8239232,1.80090622 L11.8680265,0.713470428 C12.0239577,0.550956389 12.0239577,0.288568039 11.8680265,0.126054 C11.7119601,-0.0364318733 11.4599818,-0.0364318733 11.3040235,0.126054 L10.1199473,1.35510514 C9.4799668,1.0259086 8.76395461,0.834271591 7.99995943,0.834271591 C7.23193411,0.834271591 6.51199997,1.0259086 5.86801636,1.35927362 L4.68004524,0.121885529 C4.52397881,-0.0406285097 4.27200051,-0.0406285097 4.11593409,0.121885529 C3.95997586,0.284371402 3.95997586,0.546787918 4.11593409,0.709273792 L5.16393229,1.80090622 C3.97593412,2.71340706 3.20001082,4.18000472 3.20001082,5.83404275 L12.8000162,5.83404275 C12.8000162,4.17580808 12.0199546,2.70923859 10.8239232,1.80090622 Z M14.7999655,6.66734263 C14.1360205,6.66734263 13.599931,7.22569243 13.599931,7.91729247 L13.599931,13.7503917 C13.599931,14.4419635 14.1360205,15.0003415 14.7999655,15.0003415 C15.4639105,15.0003415 16,14.4419635 16,13.7503917 L16,7.91729247 C16,7.22569243 15.4639105,6.66734263 14.7999655,6.66734263 Z M1.20003449,6.66734263 C0.536008371,6.66734263 0,7.22569243 0,7.91729247 L0,13.7503917 C0,14.4419635 0.536008371,15.0003415 1.20003449,15.0003415 C1.86397946,15.0003415 2.39998783,14.4419635 2.39998783,13.7503917 L2.39998783,7.91729247 C2.39998783,7.22569243 1.86397946,6.66734263 1.20003449,6.66734263 Z M3.20001082,15.0003415 C3.20001082,15.4585635 3.55996436,15.8336132 4.00003381,15.8336132 L4.79994861,15.8336132 L4.79994861,18.7500502 C4.79994861,19.4417629 5.33595698,20 5.9999831,20 C6.66392807,20 7.19993644,19.4417629 7.19993644,18.7500502 L7.19993644,15.8335287 L8.79998242,15.8335287 L8.79998242,18.7500502 C8.79998242,19.4416502 9.33596374,20 10.0000169,20 C10.6639619,20 11.1999432,19.4416502 11.1999432,18.7500502 L11.1999432,15.8335287 L11.9999662,15.8335287 C12.4399274,15.8335287 12.8000162,15.4585635 12.8000162,15.0002288 L12.8000162,6.66734263 L3.20001082,6.66734263 L3.20001082,15.0003415 Z"
                              id="Android"></path>
                          </g>
                        </g>
                      </g>
                    </g>
                  </svg>
                </i>
                <span class="text">安卓下载</span>
              </div>
            </a>
          </div>
        </div>
      </div>
      <div class="subtit clear mt59">
        <span class="nub">2</span>
        <span class="text">使用谷歌验证器扫描下方二维码</span>
      </div>
      <div class="code">
        <canvas id="qrcode" width="190" height="190"></canvas>
      </div>

      <div class="subtit mt59">
        <span class="nub">3</span>
        <span class="text">请把下方的密钥保存到一个安全的地方</span>
      </div>
      <div class="secret-key">
        <span class="key">&nbsp;{{authentication.gaSecret}}&nbsp;</span>
        <el-button type="text" v-clipboard:copy="authentication.gaSecret" v-clipboard:success="onCopy"
                   :disabled="authentication.gaSecret ==''">复制
        </el-button>
        <el-button type="text" @click="save" :disabled="authentication.gaSecret ==''">保存到本地</el-button>
        <div class="secret-key-text">如果您需要重置谷歌验证码(如手机丢失、被盗、或更换)却未保存此密钥，重置流程至少需要 <span
          class="jobDate">7个工作日</span>。
        </div>
      </div>

      <div class="subtit mt59">
        <span class="nub">4</span>
        <span class="text">在下面输入您谷歌验证器中显示的6位数字验证码：</span>
      </div>
      <div class="code-input">
        <div class="inptarr">
          <div class="inpt">
            <input type="text" maxlength="1" v-model="inpt1">
            <div class="line"></div>
          </div>
          <div class="inpt">
            <input type="text" maxlength="1" v-model="inpt2">
            <div class="line"></div>
          </div>
          <div class="inpt">
            <input type="text" maxlength="1" v-model="inpt3">
            <div class="line"></div>
          </div>
          <div class="inpt">
            <input type="text" maxlength="1" v-model="inpt4">
            <div class="line"></div>
          </div>
          <div class="inpt">
            <input type="text" maxlength="1" v-model="inpt5">
            <div class="line"></div>

          </div>
          <div class="inpt">
            <input type="text" maxlength="1" v-model="inpt6">
          </div>
        </div>
        <div class="beginbtn clear" @click="beginCode">立即开启</div>
      </div>
    </div>

  </div>
</template>
<script>
  import saveText from '../../assets/js/fileSaver';

  export default {
    name: 'guge',
    data() {
      return {
        authentication: {},
        QRCode: require('qrcode'),
        inpt1: '',
        inpt2: '',
        inpt3: '',
        inpt4: '',
        inpt5: '',
        inpt6: ''
      };
    },
    watch: {
      inpt1(newVal, oldVal) {
        if (newVal == '') return;
        let regx = /^\d+$/g;
        if (!regx.test(newVal)) {
          this.inpt1 = oldVal;
        }
      },
      inpt2(newVal, oldVal) {
        if (newVal == '') return;
        let regx = /^\d+$/g;
        if (!regx.test(newVal)) {
          this.inpt2 = oldVal;
        }
      },
      inpt3(newVal, oldVal) {
        if (newVal == '') return;
        let regx = /^\d+$/g;
        if (!regx.test(newVal)) {
          this.inpt3 = oldVal;
        }
      },
      inpt4(newVal, oldVal) {
        if (newVal == '') return;
        let regx = /^\d+$/g;
        if (!regx.test(newVal)) {
          this.inpt4 = oldVal;
        }
      },
      inpt5(newVal, oldVal) {
        if (newVal == '') return;
        let regx = /^\d+$/g;
        if (!regx.test(newVal)) {
          this.inpt5 = oldVal;
        }
      },
      inpt6(newVal, oldVal) {
        if (newVal == '') return;
        let regx = /^\d+$/g;
        if (!regx.test(newVal)) {
          this.inpt6 = oldVal;
        }
      }
    },
    methods: {
      onCopy() {
        this.$message({
          title: '成功',
          message: '复制成功',
          type: 'success'
        });
      },
      save() {
        let blob = new Blob([this.authentication.gaSecret], {type: 'text/plain;charset=utf-8'});
        saveText(blob, 'secret-key.txt');
      },
      getGAuthenticationDatas() {
        var vm = this;
        getajaxdata(API.getGAuthentication, 'POST', '', 'JSON', function (res) {
          if (res.code == '1000') {
            vm.authentication = res.data;
            vm.QRCode.toCanvas(document.getElementById('qrcode'), res.data.qrCode, {
              width: '190',
              height: '190'
            });
          }
        });
      },
      beginCode() {
        if (!this.inpt1 || !this.inpt2 || !this.inpt3 || !this.inpt4 || !this.inpt5 || !this.inpt6) {
          this.$message({
            message: '请填入完整信息',
            type: 'warning'
          });
          return;
        };
        var form = this.inpt1 + this.inpt2 + this.inpt3 + this.inpt4 + this.inpt5 + this.inpt6,
          arr = {
            gaSecret: this.authentication.gaSecret,
            verifyCode: form
          },
          vm = this;
        getajaxdata(API.setGAuthentication, 'POST', arr, 'JSON', function (res) {
          if (res.code == '1000') {
            var isbind = JSON.parse(localStorage.getItem('userInfo')) || '';
            isbind.isGaSecret = true;
            setDataToLocal('userInfo',JSON.stringify(isbind));
            vm.$message({
              message: '谷歌验证器绑定成功',
              type: 'success'
            });
            setTimeout(function () {
              vm.$router.push(vm.$route.query.page);
            }, 3000);
          } else {
            vm.$message.error(res.message);
          }
        });
      }
    },
    mounted() {
      this.getGAuthenticationDatas();
    }
  };
</script>
<style scoped>
  .jobDate {
    color: #E94F4F;
  }
</style>
